---
title: "Figure 1"
output: html_document
---

## First step to load packages and file locations etc.
```{r include=FALSE}
rm(list=ls())
project.folder = paste0(print(here::here()),'/')
source(paste0(project.folder,'create_folder_structure.R'))
source(paste0(functions.folder,'script_initiate.R'))
```

## Load specific plotting packages
```{r, message=FALSE}
# load required packages
library(data.table)
library(maptools)
library(mapproj)
library(rgeos)
library(rgdal)
library(RColorBrewer)
library(ggplot2)
library(raster)
library(sp)
library(plyr)
library(graticule)
library(zoo)
library(purrr)
library(cowplot)
```

## Load US prison shapefile for load details
```{r}
# load shapefile of entire United States by prison
us.main = readOGR(dsn=paste0(project.folder,"data/shapefiles/Prison_Boundaries/"),
                           layer="Prison_Boundaries_Edited")

us.main = spTransform(us.main, CRS("+proj=laea +lat_0=45 +lon_0=-100 +x_0=0 +y_0=0 +a=6370997 +b=6370997 +units=m +no_defs"))

# fortify to prepare for plotting in ggplot
map = fortify(us.main)

# extract data from shapefile
us.main@data$id = rownames(us.main@data) 
shapefile.data = us.main@data

# merge selected data to map_create dataframe for colouring of ggplot
USA.df = merge(map, shapefile.data, by='id')
USA.df$prison_id = as.integer(as.character(USA.df$FID))
```

## Load WBGT over time file
```{r}
dat.wbgt.summarised = readRDS(paste0(wbgt.folder,'weighted_area_raster_prison_wbgtmax_daily_',start_year_wbgt,'_',end_year_wbgt,'_over_time.rds'))
```

## Merge prison over time file with shapefile data then summarise by state and year weighted by prison population
```{r}
dat.wbgt.summarised.merged.weighted.prison = left_join(dat.wbgt.summarised,shapefile.data, by=c('prison_id'='FID')) %>% 
  dplyr::filter(STATUS=='OPEN') %>% 
  dplyr::filter(POPULATION > 0) %>%
  dplyr::group_by(STATE,STATEFP,TYPE,year) %>%
  dplyr::summarise(wbgt_26 = weighted.mean(wbgt_26,POPULATION),
            wbgt_28 = weighted.mean(wbgt_28,POPULATION),
            wbgt_30 = weighted.mean(wbgt_30,POPULATION),
            wbgt_35 = weighted.mean(wbgt_35,POPULATION),
            POPULATION = sum(POPULATION)) %>%
  dplyr::mutate(STATE=factor(STATE, levels=rev(sort(unique(STATE))))) %>%
  dplyr::mutate(wbgt_26_pop = wbgt_26 * POPULATION,
                wbgt_28_pop = wbgt_28 * POPULATION,
                wbgt_30_pop = wbgt_30 * POPULATION,
                wbgt_35_pop = wbgt_35 * POPULATION)
```

## Take 5-year average of most recent 5 years
```{r}
dat.wbgt.summarised.merged.weighted.prison.5year.average = dat.wbgt.summarised.merged.weighted.prison %>%
  dplyr::filter(year%in%years_wbgtmax[c((length(years_wbgtmax)-4):length(years_wbgtmax))]) %>%
  dplyr::group_by(STATE,STATEFP,TYPE) %>%
  dplyr::summarise(wbgt_26_pop_mean = mean(wbgt_26_pop),
                   wbgt_28_pop_mean = mean(wbgt_28_pop),
                   wbgt_30_pop_mean = mean(wbgt_30_pop),
                   wbgt_35_pop_mean = mean(wbgt_35_pop)) %>%
  dplyr::rename(Type=TYPE) %>%
  dplyr::mutate(Type=case_when(Type=='COUNTY' ~ 'County',
                               Type=='LOCAL' ~ 'Local',
                               Type=='FEDERAL' ~ 'Federal',
                               Type=='STATE' ~ 'State',
                               TRUE ~ 'Other')) %>%
  dplyr::mutate(Type=as.factor(Type)) %>%
  dplyr::mutate(Type=factor(Type,levels=c('Federal','State','County','Local','Other')))
```

## Plot barchart by state stacked by prison type
```{r}
library(MetBrewer)

plot_bar_chart = function(threshold_chosen,legend_chosen=1){ 
  
  # calculate rank of bars
  dat.rank = dat.wbgt.summarised.merged.weighted.prison.5year.average %>%
    group_by(STATE) %>%
    dplyr::summarise(sum=sum(get(paste0('wbgt_',threshold_chosen,'_pop_mean')))) %>%
    dplyr::arrange(sum) %>%
    dplyr::mutate(rank=row_number())
  
  dat.plot = left_join(dat.wbgt.summarised.merged.weighted.prison.5year.average,dat.rank)

 p = ggplot() + 
   geom_bar(data=dat.plot, 
                aes(x=reorder(STATE, rank),
                              y=get(paste0('wbgt_',threshold_chosen,'_pop_mean')),fill=Type),stat = "identity") +
   ylab('Annual hot-humid person-days for those incarcerated') + 
   xlab('State') + 
   scale_y_continuous(label=scales::comma) + 
   coord_flip() +
   scale_fill_manual(values=met.brewer('Lakota')) + 
   theme_bw() + theme(text = element_text(size = 10), 
   panel.grid.major = element_blank(),axis.text.x = element_text(angle=0 , size=8, vjust=0.5), 
   plot.title = element_text(hjust = 0.5),panel.background = element_blank(), 
   panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), 
   panel.border = element_rect(colour = "black"),strip.background = element_blank(), 
   legend.position = 'bottom',legend.justification='center', 
   legend.background = element_rect(fill="white", size=.5, linetype="dotted")) 

 return(p) 
}

plot.bar.chart.26 = plot_bar_chart(26,1)
plot.bar.chart.28 = plot_bar_chart(28,1)
plot.bar.chart.30 = plot_bar_chart(30,1)
```

## 26°C: Plot
```{r}
pdf(paste0(wbgtmax.folder,'Figure_1_26.pdf'),paper='a4r',width=0,height=0)
print(plot.bar.chart.26)
dev.off()

plot.bar.chart.26
```

## 28°C: Plot
```{r}
pdf(paste0(wbgtmax.folder,'Figure_1_28.pdf'),paper='a4r',width=0,height=0)
print(plot.bar.chart.28)
dev.off()

plot.bar.chart.28
```

## Save output data
```{r}
dat.wbgt.summarised.merged.weighted.prison.5year.average.rounded = dat.wbgt.summarised.merged.weighted.prison.5year.average %>%
  mutate(wbgt_26_pop_mean=round(wbgt_26_pop_mean),
         wbgt_28_pop_mean=round(wbgt_28_pop_mean),
         wbgt_30_pop_mean=round(wbgt_30_pop_mean),
         wbgt_35_pop_mean=round(wbgt_35_pop_mean))

dat.wbgt.summarised.merged.weighted.prison.5year.average.rounded.total = dat.wbgt.summarised.merged.weighted.prison.5year.average.rounded %>%
  group_by(STATE,STATEFP) %>%
  dplyr::summarise(wbgt_26_pop_mean=sum(wbgt_26_pop_mean),
         wbgt_28_pop_mean=sum(wbgt_28_pop_mean),
         wbgt_30_pop_mean=sum(wbgt_30_pop_mean),
         wbgt_35_pop_mean=sum(wbgt_35_pop_mean)) %>%
  mutate(Type='Total') %>%
dplyr::relocate(Type)

dat.wbgt.summarised.merged.weighted.prison.5year.average.rounded = rbind(dat.wbgt.summarised.merged.weighted.prison.5year.average.rounded,
                                                                         dat.wbgt.summarised.merged.weighted.prison.5year.average.rounded.total) %>%
  arrange(STATEFP)

readr::write_csv(dat.wbgt.summarised.merged.weighted.prison.5year.average.rounded ,paste0(wbgtmax.folder,'Figure_1.csv'))
```